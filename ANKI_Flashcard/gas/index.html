<!doctype html>
<html>
<head>
<base target="_top" />
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flashcards</title>
<style>
:root {
--bg: #0b1020;
--panel: rgba(255, 255, 255, 0.06);
--panel-2: rgba(255, 255, 255, 0.1);
--text: rgba(255, 255, 255, 0.92);
--muted: rgba(255, 255, 255, 0.7);
--muted-2: rgba(255, 255, 255, 0.55);
--line: rgba(255, 255, 255, 0.12);
--accent: #9effd4;
--danger: #ff6b6b;
--radius: 16px;
--hanzi-font: ui-sans-serif, system-ui, -apple-system, "PingFang SC",
"Hiragino Sans GB", "Noto Sans SC", "Microsoft YaHei", Segoe UI, Roboto,
Helvetica, Arial;

/* Grade colors (difficulty grouping; used later for logic) */
--grade-1: #a100ff;
--grade-2: #ff7a00;
--grade-3: #ffd000;
--grade-4: #45c04a;
}

* {
box-sizing: border-box;
}

html,
body {
height: 100%;
margin: 0;
color: var(--text);
background: radial-gradient(
1200px 800px at 20% 20%,
rgba(158, 255, 212, 0.18),
transparent 60%
),
radial-gradient(
1000px 700px at 80% 20%,
rgba(120, 145, 255, 0.18),
transparent 55%
),
radial-gradient(
1200px 800px at 50% 90%,
rgba(255, 107, 107, 0.12),
transparent 50%
),
var(--bg);
font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
}

.wrap {
min-height: 100%;
display: flex;
align-items: center;
justify-content: center;
padding: 24px;
}

.card {
width: min(720px, 100%);
border: 1px solid var(--line);
background: linear-gradient(180deg, var(--panel), rgba(0, 0, 0, 0.08));
border-radius: var(--radius);
box-shadow: 0 30px 90px rgba(0, 0, 0, 0.55);
overflow: hidden;
}

.header {
display: flex;
gap: 12px;
justify-content: space-between;
align-items: flex-start;
padding: 18px 20px;
border-bottom: 1px solid var(--line);
}

.title {
font-weight: 700;
letter-spacing: 0.3px;
}

.header-right {
display: flex;
flex-direction: column;
align-items: flex-end;
gap: 8px;
min-width: 0;
}

.controls {
display: flex;
gap: 8px;
align-items: center;
flex-wrap: wrap;
justify-content: flex-end;
}

.chip,
.chip-select {
appearance: none;
border: 1px solid var(--line);
background: rgba(255, 255, 255, 0.04);
color: rgba(255, 255, 255, 0.86);
border-radius: 999px;
padding: 7px 10px;
font-weight: 700;
font-size: 12px;
letter-spacing: 0.18px;
cursor: pointer;
transition: transform 140ms ease, background 140ms ease,
border-color 140ms ease, opacity 140ms ease;
user-select: none;
touch-action: manipulation;
}
.chip:hover,
.chip-select:hover {
background: rgba(255, 255, 255, 0.08);
border-color: rgba(255, 255, 255, 0.18);
transform: translateY(-1px);
}
.chip:active,
.chip-select:active {
transform: translateY(0px);
}
.chip-select {
padding-right: 28px;
}

.status {
font-size: 12px;
color: var(--muted-2);
text-align: right;
max-width: 55%;
overflow-wrap: anywhere;
}

.body {
padding: 22px 20px 18px;
}

.prompt {
text-align: center;
font-family: var(--hanzi-font);
font-size: clamp(88px, 30vw, 200px);
line-height: 1.02;
font-weight: 800;
letter-spacing: 0.2px;
padding: 6px 0 2px;
text-shadow: 0 10px 34px rgba(0, 0, 0, 0.35);
overflow-wrap: anywhere;
}

.prompt-wrap {
position: relative;
display: inline-block;
overflow: visible;
}

.audio-btn {
appearance: none;
width: 44px;
height: 44px;
border-radius: 999px;
border: 1px solid var(--line);
background: rgba(255, 255, 255, 0.06);
color: rgba(255, 255, 255, 0.92);
cursor: pointer;
display: grid;
place-items: center;
transition: transform 140ms ease, background 140ms ease,
border-color 140ms ease, opacity 140ms ease;
user-select: none;
touch-action: manipulation;
}
.audio-btn:hover {
background: rgba(255, 255, 255, 0.09);
border-color: rgba(255, 255, 255, 0.18);
transform: translateY(-1px);
}
.audio-btn:active {
transform: translateY(0px);
}
.audio-btn:disabled {
opacity: 0.45;
cursor: not-allowed;
transform: none;
}

.audio-ico {
width: 18px;
height: 18px;
display: block;
}

.meta {
color: var(--muted-2);
margin-top: 8px;
text-align: center;
display: none;
flex-direction: column;
align-items: center;
gap: 6px;
}
.card.is-revealed .meta {
display: flex;
}

.meta-line:empty {
display: none;
}

.meta-pinyin {
font-size: 16px;
}

.meta-alt {
font-family: var(--hanzi-font);
font-size: clamp(20px, 6.2vw, 34px);
line-height: 1.08;
font-weight: 760;
color: rgba(255, 255, 255, 0.78);
}

.divider {
display: none;
width: min(520px, 74%);
height: 2px;
border-radius: 999px;
margin: 18px auto 6px;
background: rgba(255, 255, 255, 0.16);
opacity: 0;
transform: scaleX(0.85);
transition: opacity 180ms ease, transform 220ms ease;
}
.card.is-revealed .divider {
display: block;
opacity: 1;
transform: scaleX(1);
}

.answer {
margin-top: 16px;
padding: 0;
border: 0;
border-radius: 0;
background: transparent;
color: var(--text);
font-size: clamp(22px, 6.2vw, 48px);
line-height: 1.18;
text-align: center;
display: none;
}
.answer.show {
display: block;
}

.footer {
padding: 16px 20px 20px;
border-top: 1px solid var(--line);
display: flex;
gap: 12px;
flex-wrap: wrap;
align-items: center;
justify-content: space-between;
}

.btn {
appearance: none;
border: 1px solid var(--line);
background: rgba(255, 255, 255, 0.06);
color: var(--text);
border-radius: 14px;
padding: 12px 14px;
font-weight: 650;
letter-spacing: 0.2px;
cursor: pointer;
transition: transform 140ms ease, background 140ms ease,
border-color 140ms ease;
user-select: none;
touch-action: manipulation;
}
.btn:hover {
background: rgba(255, 255, 255, 0.09);
border-color: rgba(255, 255, 255, 0.18);
transform: translateY(-1px);
}
.btn:active {
transform: translateY(0px);
}
.btn:disabled {
opacity: 0.55;
cursor: not-allowed;
transform: none;
}

.btn-primary {
border-color: rgba(158, 255, 212, 0.35);
background: rgba(158, 255, 212, 0.14);
}
.btn-primary:hover {
background: rgba(158, 255, 212, 0.2);
}

.btn-reveal {
letter-spacing: 0.22em;
text-transform: uppercase;
padding: 14px 16px;
}

.btn-row {
display: flex;
gap: 10px;
flex-wrap: wrap;
align-items: center;
}

.grade {
width: 56px;
height: 56px;
padding: 0;
border-radius: 999px;
border-color: transparent;
text-align: center;
font-variant-numeric: tabular-nums;
font-weight: 800;
font-size: 16px;
color: rgba(255, 255, 255, 0.96);
text-shadow: 0 8px 18px rgba(0, 0, 0, 0.28);
}

.grade[data-score="1"] {
background: var(--grade-1);
}
.grade[data-score="2"] {
background: var(--grade-2);
}
.grade[data-score="3"] {
background: var(--grade-3);
color: rgba(10, 10, 10, 0.9);
text-shadow: none;
}
.grade[data-score="4"] {
background: var(--grade-4);
}

.grade-wrap {
display: none;
width: 100%;
flex-direction: column;
align-items: center;
gap: 10px;
}
.card.is-revealed .grade-wrap {
display: flex;
}
.card.is-revealed #revealBtn {
display: none;
}

.grade-label {
color: var(--muted);
font-size: 14px;
text-align: center;
}

.error {
color: var(--danger);
}

/* Phone layout: fill the visible screen (incl. safe areas) and keep actions reachable. */
@media (max-width: 520px) {
.wrap {
min-height: 100svh;
padding: calc(10px + env(safe-area-inset-top))
calc(10px + env(safe-area-inset-right))
calc(10px + env(safe-area-inset-bottom))
calc(10px + env(safe-area-inset-left));
align-items: stretch;
}

.card {
flex: 1;
min-height: 0;
display: flex;
flex-direction: column;
}

.body {
flex: 1;
min-height: 0;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
text-align: center;
overflow: auto;
-webkit-overflow-scrolling: touch;
padding: 18px 16px 10px;
}

.footer {
flex-shrink: 0;
flex-wrap: nowrap;
flex-direction: column;
align-items: stretch;
justify-content: flex-end;
padding: 14px 16px 16px;
}

.btn-row.actions {
display: grid;
grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr);
grid-template-areas:
". play next"
"reveal reveal reveal";
align-items: center;
}

#nextBtn {
width: auto;
grid-area: next;
justify-self: end;
}

#playBtn {
grid-area: play;
justify-self: center;
}

.btn-reveal {
width: 100%;
padding: 18px 16px;
font-size: 16px;
border-radius: 18px;
}

#revealBtn {
grid-area: reveal;
}

.grade-row {
justify-content: center;
}
}
</style>
</head>
<body>
<div class="wrap">
<div class="card" id="card">
<div class="header">
<div class="title">ANKI Flashcard</div>
<div class="header-right">
<div class="controls" aria-label="Display settings">
<button class="chip" id="scriptToggle" type="button" title="Toggle prompt script (Simplified/Traditional)">
简
</button>
<select class="chip-select" id="fontSelect" title="Hanzi font" aria-label="Hanzi font">
<option value="default">Font: Default</option>
<option value="serif">Font: Serif (Song)</option>
<option value="cursive">Font: Cursive (Kai)</option>
<option value="custom">Font: Custom…</option>
</select>
</div>
<div class="status" id="status">Loading…</div>
</div>
</div>
<div class="body">
<div class="prompt-wrap">
<div class="prompt" id="prompt"> </div>
</div>
<audio id="audio" preload="auto"></audio>
<div class="meta" id="meta">
<div class="meta-line meta-pinyin" id="metaPinyin"></div>
<div class="meta-line meta-alt" id="metaAlt"></div>
</div>
<div class="divider" id="divider"></div>
<div class="answer" id="answer"></div>
</div>
<div class="footer">
<div class="btn-row actions">
<button
class="audio-btn"
id="playBtn"
title="Play audio"
aria-label="Play audio"
disabled
>
<svg
class="audio-ico"
viewBox="0 0 24 24"
fill="currentColor"
aria-hidden="true"
>
<path d="M8 5v14l11-7z"></path>
</svg>
</button>
<button class="btn" id="nextBtn" title="Skip without grading">
Next
</button>
<button class="btn btn-primary btn-reveal" id="revealBtn">
Reveal
</button>
</div>

<div class="grade-wrap" id="gradeWrap">
<div class="grade-label">How well did you know this?</div>
<div class="btn-row grade-row">
<button class="btn grade" data-score="1" disabled>1</button>
<button class="btn grade" data-score="2" disabled>2</button>
<button class="btn grade" data-score="3" disabled>3</button>
<button class="btn grade" data-score="4" disabled>4</button>
</div>
</div>
</div>
</div>
</div>

<script>
  let current = null;
  let prefetched = null;
  let revealed = false;
  let busy = false;
  let prefetching = false;
  let audioUnlocked = false;

  const cardEl = document.getElementById("card");
  const statusEl = document.getElementById("status");
  const promptEl = document.getElementById("prompt");
  const metaPinyinEl = document.getElementById("metaPinyin");
  const metaAltEl = document.getElementById("metaAlt");
  const answerEl = document.getElementById("answer");
  const audioEl = document.getElementById("audio");
  const playBtn = document.getElementById("playBtn");
  const revealBtn = document.getElementById("revealBtn");
  const nextBtn = document.getElementById("nextBtn");
  const gradeBtns = Array.from(document.querySelectorAll(".grade"));
  const scriptToggleBtn = document.getElementById("scriptToggle");
  const fontSelect = document.getElementById("fontSelect");

  const LS_SCRIPT_MODE = "anki_script_mode"; // "simplified" | "traditional"
  const LS_HANZI_FONT_PRESET = "anki_hanzi_font_preset"; // "default" | "serif" | "cursive" | "custom"
  const LS_HANZI_FONT_CUSTOM = "anki_hanzi_font_custom";

  const FALLBACK_HANZI_STACK =
    'ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Hiragino Sans GB", "Noto Sans SC", "Microsoft YaHei", Segoe UI, Roboto, Helvetica, Arial';

  const HANZI_FONT_STACKS = {
    default: FALLBACK_HANZI_STACK,
    serif:
      '"Songti SC", "STSong", "SimSun", "Noto Serif SC", serif, ' +
      FALLBACK_HANZI_STACK,
    cursive:
      '"Kaiti SC", "KaiTi", "STKaiti", "DFKai-SB", cursive, ' +
      FALLBACK_HANZI_STACK
  };

  function getScriptMode_() {
    const raw = String(localStorage.getItem(LS_SCRIPT_MODE) || "").toLowerCase();
    return raw === "traditional" ? "traditional" : "simplified";
  }

  function setScriptMode_(mode) {
    localStorage.setItem(
      LS_SCRIPT_MODE,
      mode === "traditional" ? "traditional" : "simplified"
    );
  }

  function setScriptToggleUI_() {
    const mode = getScriptMode_();
    scriptToggleBtn.textContent = mode === "traditional" ? "繁" : "简";
    scriptToggleBtn.setAttribute(
      "aria-label",
      mode === "traditional"
        ? "Prompt script: Traditional (tap to switch)"
        : "Prompt script: Simplified (tap to switch)"
    );
  }

  function promptTextForMode_(card, mode) {
    const simp = (card && card.prompt) || "";
    const trad = (card && card.traditional) || "";
    if (mode === "traditional" && trad) return trad;
    return simp;
  }

  function altTextForMode_(card, mode) {
    const simp = (card && card.prompt) || "";
    const trad = (card && card.traditional) || "";
    if (!trad) return "";
    if (mode === "traditional") {
      if (!simp || simp === trad) return "";
      return simp;
    }
    if (!trad || trad === simp) return "";
    return trad;
  }

  function getFontPreset_() {
    const raw = String(localStorage.getItem(LS_HANZI_FONT_PRESET) || "").toLowerCase();
    return ["default", "serif", "cursive", "custom"].includes(raw) ? raw : "default";
  }

  function setFontPreset_(preset) {
    localStorage.setItem(LS_HANZI_FONT_PRESET, preset);
  }

  function setCustomFont_(value) {
    localStorage.setItem(LS_HANZI_FONT_CUSTOM, String(value || "").trim());
  }

  function getCustomFont_() {
    return String(localStorage.getItem(LS_HANZI_FONT_CUSTOM) || "").trim();
  }

  function applyHanziFont_() {
    const preset = getFontPreset_();
    let stack = HANZI_FONT_STACKS[preset] || HANZI_FONT_STACKS.default;
    if (preset === "custom") {
      const custom = getCustomFont_();
      if (custom) {
        // Always append our fallback stack to keep Hanzi glyph coverage.
        stack = custom + ", " + FALLBACK_HANZI_STACK;
      } else {
        stack = HANZI_FONT_STACKS.default;
      }
    }

    document.documentElement.style.setProperty("--hanzi-font", stack);
    fontSelect.value = preset;
  }

  function rerenderScriptOnly_() {
    if (!current) return;
    const mode = getScriptMode_();
    promptEl.textContent = promptTextForMode_(current, mode);
    if (revealed) {
      metaAltEl.textContent = altTextForMode_(current, mode);
    }
  }

  const preloadAudioEl = new Audio();
  preloadAudioEl.preload = "auto";

  function setStatus(text, isError) {
    statusEl.textContent = text || "";
    statusEl.classList.toggle("error", Boolean(isError));
  }

  function setBusy(nextBusy) {
    busy = nextBusy;
    revealBtn.disabled = busy || !current || revealed;
    nextBtn.disabled = busy;
    gradeBtns.forEach((b) => {
      b.disabled = busy || !current || !revealed;
    });
    playBtn.disabled = busy || !current || !hasAudio_(current);
  }

  function hasAudio_(card) {
    return Boolean(card && card.audioData);
  }

  function setAudioSource_(card) {
    audioEl.pause();
    audioEl.currentTime = 0;

    if (card && card.audioData) {
      audioEl.src = card.audioData;
      audioEl.load();
      return;
    }

    audioEl.removeAttribute("src");
    audioEl.load();
  }

  async function playAudioFromStart_() {
    if (!audioEl.src) return;
    try {
      audioEl.pause();
      audioEl.currentTime = 0;
      await audioEl.play();
      audioUnlocked = true;
      // If this was the first user gesture to enable audio, make the UI reflect it.
      setStatus("Ready");
    } catch (err) {
      // iOS Safari blocks audio unless play() is called from a user gesture.
    }
  }

  function renderCard(card) {
    current = card;
    revealed = false;

    cardEl.classList.remove("is-revealed");

    promptEl.textContent = promptTextForMode_(card, getScriptMode_());
    metaPinyinEl.textContent = "";
    metaAltEl.textContent = "";
    answerEl.textContent = card.answer || "";
    answerEl.classList.remove("show");

    setAudioSource_(card);

    if (hasAudio_(card) && !audioUnlocked) {
      setStatus("Tap the play button to enable audio");
    } else {
      setStatus("Ready");
    }
    setBusy(false);
  }

  function showError(err) {
    const msg =
      (err && (err.message || (err.toString && err.toString()))) ||
      "Unknown error";
    setStatus(msg, true);
    setBusy(false);
  }

  function prefetchNextCard_() {
    if (prefetching) return;
    prefetching = true;
    google.script.run
      .withSuccessHandler((card) => {
        prefetched = card;
        prefetching = false;
        if (card && card.audioData) {
          preloadAudioEl.src = card.audioData;
          preloadAudioEl.load();
        }
      })
      .withFailureHandler(() => {
        prefetched = null;
        prefetching = false;
      })
      .getNextCard();
  }

  function advanceToPrefetched_(shouldAutoplay) {
    if (busy) return;
    if (prefetched) {
      const next = prefetched;
      prefetched = null;
      renderCard(next);
      setBusy(false);
      if (shouldAutoplay) playAudioFromStart_();
      prefetchNextCard_();
      return;
    }

    setBusy(true);
    setStatus("Loading…");
    google.script.run
      .withSuccessHandler((card) => {
        renderCard(card);
        prefetchNextCard_();
      })
      .withFailureHandler(showError)
      .getNextCard();
  }

  function reveal() {
    if (!current) return;
    revealed = true;
    cardEl.classList.add("is-revealed");
    metaPinyinEl.textContent = current.pinyin ? current.pinyin : "";
    metaAltEl.textContent = altTextForMode_(current, getScriptMode_());
    answerEl.classList.add("show");
    setBusy(false);
  }

  function grade(score) {
    if (!current) return;
    const rowNumber = current.rowNumber;

    google.script.run.withFailureHandler(showError).gradeCard(rowNumber, score);

    advanceToPrefetched_(true);
  }

  revealBtn.addEventListener("click", () => {
    if (busy) return;
    reveal();
  });

  nextBtn.addEventListener("click", () => {
    advanceToPrefetched_(true);
  });

  gradeBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      if (busy) return;
      const score = Number(btn.dataset.score);
      grade(score);
    });
  });

  playBtn.addEventListener("click", () => {
    if (busy || !current) return;
    playAudioFromStart_();
  });

  audioEl.addEventListener("error", () => {
    setStatus("Audio failed to load", true);
  });

  scriptToggleBtn.addEventListener("click", () => {
    const next = getScriptMode_() === "traditional" ? "simplified" : "traditional";
    setScriptMode_(next);
    setScriptToggleUI_();
    rerenderScriptOnly_();
  });

  fontSelect.addEventListener("change", () => {
    const nextPreset = String(fontSelect.value || "default");
    if (nextPreset !== "custom") {
      setFontPreset_(nextPreset);
      applyHanziFont_();
      return;
    }

    // Keep this simple: custom is assumed to be an installed local font family,
    // or a full CSS font-family stack. (Webfont loading is a separate concern.)
    const currentCustom = getCustomFont_();
    const input = window.prompt(
      'Custom Hanzi font-family (examples: "Kaiti SC"  or  "MyFont", "Kaiti SC")',
      currentCustom
    );
    if (input === null) {
      // User cancelled; revert select to the previous preset.
      fontSelect.value = getFontPreset_();
      return;
    }

    setCustomFont_(input);
    setFontPreset_("custom");
    applyHanziFont_();
  });

  window.addEventListener("keydown", (e) => {
    if (busy) return;
    if (e.key === " " || e.key === "Enter") {
      e.preventDefault();
      if (!revealed) reveal();
      return;
    }
    if (revealed && ["1", "2", "3", "4"].includes(e.key)) {
      e.preventDefault();
      grade(Number(e.key));
    }
    if (e.key === "ArrowRight") {
      e.preventDefault();
      advanceToPrefetched_(false);
    }
  });

  setBusy(true);
  setStatus("Loading…");

  setScriptToggleUI_();
  applyHanziFont_();

  google.script.run
    .withSuccessHandler((card) => {
      renderCard(card);
      prefetchNextCard_();
    })
    .withFailureHandler(showError)
    .getNextCard();
</script>
</body>
</html>
