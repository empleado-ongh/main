<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>学习计划</title>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #ffffff;
}

.container {
  max-width: 600px;
  margin: auto;
  padding: 16px;
}

h1 {
  font-size: 20px;
  margin-bottom: 16px;
}

.event-card {
  padding: 14px 16px;
  margin-bottom: 12px;
  border-radius: 14px;
  background: #f7f7f7;
  transition: transform 0.15s ease, background 0.15s ease;
}

.event-card:active {
  transform: scale(0.98);
  background: #ececec;
}

.event-date {
  font-size: 13px;
  color: #888;
  margin-bottom: 4px;
}

.event-title {
  font-size: 16px;
  font-weight: 500;
}

.empty {
  color: #888;
  font-size: 14px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>

</head>
<body>

<div class="container">
  <h1>即将到来的学习</h1>
  <div id="events"></div>
</div>

<script>

const icsUrl =
  'https://api.allorigins.win/raw?url=' +
  encodeURIComponent(
    'https://calendar.google.com/calendar/ical/e75be93f20e20f3b938b2c5af4ec78c4307101f054f7fde80cb32869f0c7c141@group.calendar.google.com/public/basic.ics'
  );

fetch(icsUrl)
  .then(response => response.text())
  .then(data => {
    const jcalData = ICAL.parse(data);
    const comp = new ICAL.Component(jcalData);
    const events = comp.getAllSubcomponents('vevent');

    const now = new Date();
    const upcoming = [];

    events.forEach(event => {
      const vevent = new ICAL.Event(event);
      const start = vevent.startDate.toJSDate();

      if (start >= now) {
        upcoming.push({
          title: vevent.summary,
          date: start,
          description: vevent.description || ''
        });
      }
    });

    upcoming.sort((a,b) => a.date - b.date);

    const nextEvents = upcoming.slice(0, 10);

    const container = document.getElementById('events');

    if (nextEvents.length === 0) {
      container.innerHTML = '<div class="empty">暂无未来活动</div>';
      return;
    }

    nextEvents.forEach(event => {
      const card = document.createElement('div');
      card.className = 'event-card';

      const date = document.createElement('div');
      date.className = 'event-date';
      date.innerText = event.date.toLocaleDateString('zh-CN', {
        month: 'long',
        day: 'numeric',
        weekday: 'short'
      });

      const title = document.createElement('div');
      title.className = 'event-title';
      title.innerText = event.title;

      card.appendChild(date);
      card.appendChild(title);

      // Handle click navigation
      const routeMatch = event.description.match(/ROUTE:(.*)/);

      if (routeMatch) {
        const route = routeMatch[1].trim();
        card.style.cursor = 'pointer';

        card.addEventListener('click', () => {
          window.location.href = route;
        });
      }

      container.appendChild(card);
    });

  })
  .catch(error => {
    document.getElementById('events').innerHTML =
      '<div class="empty">加载失败</div>';
  });

</script>

</body>
</html>