<div class="home-calendar-frame">
  <div id="home-calendar" class="home-calendar-widget" aria-label="Upcoming events">
    <p class="home-calendar-fallback">Loading upcoming events...</p>
  </div>
</div>

<script>
  (function () {
    const FEED_URL = "{{ '/assets/calendar.json' | relative_url }}";
    const CACHE_KEY = 'home-calendar-events:v1';
    const CACHE_TTL_MS = 24 * 60 * 60 * 1000; // 24h

    function loadCssOnce(href, id) {
      if (id && document.getElementById(id)) return Promise.resolve();

      return new Promise(function (resolve, reject) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        if (id) link.id = id;
        link.onload = function () { resolve(); };
        link.onerror = function () { reject(new Error('Failed to load CSS: ' + href)); };
        document.head.appendChild(link);
      });
    }

    function loadScriptOnce(src, id) {
      if (id && document.getElementById(id)) return Promise.resolve();

      return new Promise(function (resolve, reject) {
        const script = document.createElement('script');
        script.src = src;
        if (id) script.id = id;
        script.defer = true;
        script.onload = function () { resolve(); };
        script.onerror = function () { reject(new Error('Failed to load script: ' + src)); };
        document.head.appendChild(script);
      });
    }

    function ensureFullCalendar() {
      if (window.FullCalendar && window.FullCalendar.Calendar) return Promise.resolve();

      // Avoid duplicate loads if this include runs more than once.
      if (window.__homeCalendarAssetsPromise) return window.__homeCalendarAssetsPromise;

      const css = loadCssOnce(
        'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css',
        'home-fullcalendar-css'
      );

      window.__homeCalendarAssetsPromise = css
        .then(function () {
          return loadScriptOnce(
            'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js',
            'home-fullcalendar-js'
          );
        })
        .then(function () {
          return loadScriptOnce(
            'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/zh-cn.global.min.js',
            'home-fullcalendar-locale'
          );
        });

      return window.__homeCalendarAssetsPromise;
    }

    function readCache() {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || !Array.isArray(parsed.events)) return null;
        if (typeof parsed.ts !== 'number') return null;
        if (Date.now() - parsed.ts > CACHE_TTL_MS) return null;
        return parsed.events;
      } catch (_) {
        return null;
      }
    }

    function writeCache(events) {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), events: events }));
      } catch (_) {
        // Ignore storage errors (private mode/quota).
      }
    }

    function fetchJsonWithTimeout(url, timeoutMs) {
      const controller = new AbortController();
      const timer = setTimeout(function () { controller.abort(); }, timeoutMs);

      return fetch(url, { signal: controller.signal, credentials: 'same-origin' })
        .then(function (res) {
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        })
        .finally(function () {
          clearTimeout(timer);
        });
    }

    function cacheBustedUrl(url) {
      // Bucketed cache-bust to avoid iOS Safari aggressively caching JSON forever.
      const bucket = Math.floor(Date.now() / (60 * 60 * 1000)); // hourly
      return url + (url.indexOf('?') === -1 ? '?' : '&') + 'v=' + bucket;
    }

    function loadEvents() {
      const url = cacheBustedUrl(FEED_URL);

      return fetchJsonWithTimeout(url, 8000)
        .then(function (data) {
          if (!Array.isArray(data)) throw new Error('Invalid feed format');
          writeCache(data);
          return data;
        })
        .catch(function () {
          const cached = readCache();
          if (cached) return cached;
          throw new Error('Feed fetch failed');
        });
    }

    function toUpcoming(events, limit) {
      const now = new Date();
      return events
        .filter(function (e) { return e && e.start && new Date(e.start) >= now; })
        .sort(function (a, b) { return new Date(a.start) - new Date(b.start); })
        .slice(0, limit || 10);
    }

    function render(events) {
      const el = document.getElementById('home-calendar');
      if (!el) return;

      if (!window.FullCalendar || !window.FullCalendar.Calendar) {
        const fallback = el.querySelector('.home-calendar-fallback');
        if (fallback) fallback.textContent = 'Calendar failed to load.';
        return;
      }

      const fallback = el.querySelector('.home-calendar-fallback');
      if (fallback) fallback.remove();

      const upcoming = toUpcoming(events || [], 10);

      const calendar = new FullCalendar.Calendar(el, {
        locale: 'zh-cn',
        // "Upcoming events" should be resilient even when the current month has none.
        views: {
          listNextYear: { type: 'list', duration: { days: 365 } }
        },
        initialView: 'listNextYear',
        height: 'auto',
        headerToolbar: false,
        events: upcoming
      });

      calendar.render();
    }

    document.addEventListener('DOMContentLoaded', function () {
      ensureFullCalendar()
        .then(loadEvents)
        .then(render)
        .catch(function () {
          const el = document.getElementById('home-calendar');
          if (!el) return;
          const fallback = el.querySelector('.home-calendar-fallback');
          if (fallback) fallback.textContent = 'Calendar unavailable. Please try again.';
        });
    });
  })();
</script>
